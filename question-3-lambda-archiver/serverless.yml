service: dynamodb-archiver

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  
  environment:
    SOURCE_TABLE: ${self:service}-items-${self:provider.stage}
    ARCHIVE_BUCKET: ${self:service}-archive-${self:provider.stage}
    ARCHIVE_DAYS: 30
    BATCH_SIZE: 100
    REGION: ${self:provider.region}
  
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Scan
            - dynamodb:DeleteItem
            - dynamodb:BatchWriteItem
          Resource:
            - !GetAtt SourceTable.Arn
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:PutObjectAcl
          Resource:
            - !GetAtt ArchiveBucket.Arn
            - !Join ['', [!GetAtt ArchiveBucket.Arn, '/*']]
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'

functions:
  archiveOldItems:
    handler: src/index.handler
    timeout: 900  # 15 minutes
    memorySize: 1024
    reservedConcurrency: 1  # Prevent concurrent executions
    events:
      - schedule:
          rate: cron(0 2 * * ? *)  # Run daily at 2 AM UTC
          enabled: true
          description: 'Archive items older than 30 days'

resources:
  Resources:
    SourceTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.SOURCE_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: itemId
            AttributeType: S
        KeySchema:
          - AttributeName: itemId
            KeyType: HASH
        TimeToLiveSpecification:
          Enabled: false
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
    
    ArchiveBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.ARCHIVE_BUCKET}
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            - Id: TransitionToGlacier
              Status: Enabled
              Transitions:
                - StorageClass: GLACIER
                  TransitionInDays: 90
            - Id: ExpireOldArchives
              Status: Enabled
              ExpirationInDays: 2555  # 7 years
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
    
    ArchiveBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref ArchiveBucket
        PolicyDocument:
          Statement:
            - Sid: DenyUnencryptedObjectUploads
              Effect: Deny
              Principal: '*'
              Action: s3:PutObject
              Resource: !Join ['', [!GetAtt ArchiveBucket.Arn, '/*']]
              Condition:
                StringNotEquals:
                  's3:x-amz-server-side-encryption': 'AES256'

plugins:
  - serverless-offline